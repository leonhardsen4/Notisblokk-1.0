<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Gerenciar Usu√°rios - Notisblokk</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body>
    <th:block th:replace="~{layout/base :: base(~{::main-content})}">
        <div th:fragment="main-content" x-data="usersApp()">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h1 style="font-size: 2rem; font-weight: 700; color: var(--color-text-primary);">Gerenciar Usu√°rios</h1>
                <button class="btn btn-primary" onclick="ModalManager.show('modalNewUser')">+ Novo Usu√°rio</button>
            </div>

            <!-- Alerts -->
            <div th:if="${success}" class="alert alert-success" th:text="${success}">Sucesso</div>
            <div th:if="${error}" class="alert alert-error" th:text="${error}">Erro</div>

            <!-- Barra de Pesquisa -->
            <div class="card mb-3">
                <div class="card-body">
                    <input
                        type="text"
                        x-model="termoPesquisa"
                        @input="pesquisar()"
                        placeholder="üîç Pesquisar usu√°rios por nome, username, email..."
                        class="form-input search-input"
                        style="width: 100%;"
                    >
                </div>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-3 mb-4">
                <div class="card">
                    <div class="card-body">
                        <p style="color: var(--color-text-secondary); font-size: 0.875rem;">Total de Usu√°rios</p>
                        <p style="font-size: 1.875rem; font-weight: 700; color: var(--color-text-primary);" th:text="${totalUsuarios}">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p style="color: var(--color-text-secondary); font-size: 0.875rem;">Usu√°rios Ativos</p>
                        <p style="font-size: 1.875rem; font-weight: 700; color: var(--color-success-dark);" th:text="${usuariosAtivos}">0</p>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <p style="color: var(--color-text-secondary); font-size: 0.875rem;">Usu√°rios Inativos</p>
                        <p style="font-size: 1.875rem; font-weight: 700; color: var(--color-error-dark);" th:text="${usuariosInativos}">0</p>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="card">
                <!-- Cabe√ßalho da Tabela com Controle de Colunas -->
                <div class="table-header-controls">
                    <button @click="mostrarControlesColunas = !mostrarControlesColunas" class="btn btn-secondary btn-sm btn-icon-controls" title="Configurar colunas vis√≠veis">
                        ‚öôÔ∏è Configurar Colunas
                    </button>
                </div>

                <!-- Controles de Colunas -->
                <div x-show="mostrarControlesColunas" class="column-controls-table">
                    <label class="column-toggle-compact">
                        <input type="checkbox" x-model="colunasVisiveis.id"> ID
                    </label>
                    <label class="column-toggle-compact">
                        <input type="checkbox" x-model="colunasVisiveis.nome"> Nome
                    </label>
                    <label class="column-toggle-compact">
                        <input type="checkbox" x-model="colunasVisiveis.username"> Username
                    </label>
                    <label class="column-toggle-compact">
                        <input type="checkbox" x-model="colunasVisiveis.email"> Email
                    </label>
                    <label class="column-toggle-compact">
                        <input type="checkbox" x-model="colunasVisiveis.role"> Role
                    </label>
                    <label class="column-toggle-compact">
                        <input type="checkbox" x-model="colunasVisiveis.status"> Status
                    </label>
                    <label class="column-toggle-compact">
                        <input type="checkbox" x-model="colunasVisiveis.criadoEm"> Criado em
                    </label>
                </div>

                <div class="card-body" style="padding: 0;">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th x-show="colunasVisiveis.id" @click="ordenarPor('id')" class="sortable">
                                        ID <span x-text="getSortIcon('id')"></span>
                                    </th>
                                    <th x-show="colunasVisiveis.nome" @click="ordenarPor('fullName')" class="sortable">
                                        Nome <span x-text="getSortIcon('fullName')"></span>
                                    </th>
                                    <th x-show="colunasVisiveis.username" @click="ordenarPor('username')" class="sortable">
                                        Username <span x-text="getSortIcon('username')"></span>
                                    </th>
                                    <th x-show="colunasVisiveis.email" @click="ordenarPor('email')" class="sortable">
                                        Email <span x-text="getSortIcon('email')"></span>
                                    </th>
                                    <th x-show="colunasVisiveis.role" @click="ordenarPor('roleDisplayName')" class="sortable">
                                        Role <span x-text="getSortIcon('roleDisplayName')"></span>
                                    </th>
                                    <th x-show="colunasVisiveis.status" @click="ordenarPor('active')" class="sortable">
                                        Status <span x-text="getSortIcon('active')"></span>
                                    </th>
                                    <th x-show="colunasVisiveis.criadoEm" @click="ordenarPor('formattedCreatedAt')" class="sortable">
                                        Criado em <span x-text="getSortIcon('formattedCreatedAt')"></span>
                                    </th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="user in usersProcessados" :key="user.id">
                                    <tr>
                                        <td x-show="colunasVisiveis.id" x-text="user.id">1</td>
                                        <td x-show="colunasVisiveis.nome" x-text="user.fullName">Nome</td>
                                        <td x-show="colunasVisiveis.username" x-text="user.username">username</td>
                                        <td x-show="colunasVisiveis.email" x-text="user.email">email@example.com</td>
                                        <td x-show="colunasVisiveis.role">
                                            <span :class="'badge ' + (user.admin ? 'badge-info' : 'badge-secondary')" x-text="user.roleDisplayName">Role</span>
                                        </td>
                                        <td x-show="colunasVisiveis.status">
                                            <span :class="'badge ' + (user.active ? 'badge-success' : 'badge-error')" x-text="user.active ? 'Ativo' : 'Inativo'">Status</span>
                                        </td>
                                        <td x-show="colunasVisiveis.criadoEm" x-text="user.formattedCreatedAt">--</td>
                                        <td>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-secondary btn-sm" @click="toggleUserStatus(user.id)">
                                                    <span x-text="user.active ? 'Desativar' : 'Ativar'">Toggle</span>
                                                </button>
                                                <button class="btn btn-danger btn-sm" @click="deleteUser(user.id)">Excluir</button>
                                            </div>
                                        </td>
                                    </tr>
                                </template>
                                <tr x-show="usersProcessados.length === 0">
                                    <td colspan="8" style="text-align: center; color: var(--color-text-secondary);">Nenhum usu√°rio encontrado</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal Novo Usu√°rio -->
            <div id="modalNewUser" class="modal-overlay" style="display: none;">
                <div class="modal">
                    <div class="modal-header">
                        <h3 class="modal-title">Novo Usu√°rio</h3>
                        <button class="modal-close" onclick="ModalManager.hide('modalNewUser')">&times;</button>
                    </div>
                    <form method="POST" action="/admin/users">
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Nome Completo</label>
                                <input type="text" name="fullName" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Username</label>
                                <input type="text" name="username" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" name="email" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Senha</label>
                                <input type="password" name="password" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Role</label>
                                <select name="role" class="form-select" required>
                                    <option value="OPERATOR">Operador</option>
                                    <option value="ADMIN">Administrador</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox">
                                    <input type="checkbox" name="active" checked>
                                    <span>Ativo</span>
                                </label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="ModalManager.hide('modalNewUser')">Cancelar</button>
                            <button type="submit" class="btn btn-primary">Criar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </th:block>

    <script th:inline="javascript">
        function usersApp() {
            return {
                // Estado
                users: /*[[${users}]]*/ [],
                usersFiltrados: [],
                usersProcessados: [],
                mostrarControlesColunas: false,
                colunaOrdenacao: 'id',
                direcaoOrdenacao: 'asc',
                termoPesquisa: '',
                colunasVisiveis: {
                    id: true,
                    nome: true,
                    username: true,
                    email: true,
                    role: true,
                    status: true,
                    criadoEm: true
                },

                // Inicializa√ß√£o
                init() {
                    this.usersFiltrados = [...this.users];
                    this.ordenar();
                },

                // Pesquisar usu√°rios
                pesquisar() {
                    const termo = this.termoPesquisa.toLowerCase();
                    if (termo.trim()) {
                        this.usersFiltrados = this.users.filter(u =>
                            (u.fullName || '').toLowerCase().includes(termo) ||
                            (u.username || '').toLowerCase().includes(termo) ||
                            (u.email || '').toLowerCase().includes(termo)
                        );
                    } else {
                        this.usersFiltrados = [...this.users];
                    }
                    this.ordenar();
                },

                // Computed property: usu√°rios processados (ordenados)
                get usuariosProcessados() {
                    return this.usersProcessados;
                },

                // Ordenar por coluna
                ordenarPor(coluna) {
                    if (this.colunaOrdenacao === coluna) {
                        // Alternar dire√ß√£o
                        this.direcaoOrdenacao = this.direcaoOrdenacao === 'asc' ? 'desc' : 'asc';
                    } else {
                        // Nova coluna, come√ßar em ascendente
                        this.colunaOrdenacao = coluna;
                        this.direcaoOrdenacao = 'asc';
                    }
                    this.ordenar();
                },

                // Ordenar a lista
                ordenar() {
                    this.usersProcessados = [...this.usersFiltrados].sort((a, b) => {
                        let valorA = a[this.colunaOrdenacao];
                        let valorB = b[this.colunaOrdenacao];

                        // Tratar valores booleanos (status)
                        if (typeof valorA === 'boolean') {
                            valorA = valorA ? 1 : 0;
                            valorB = valorB ? 1 : 0;
                        }
                        // Tratar strings
                        else if (typeof valorA === 'string') {
                            valorA = valorA.toLowerCase();
                            valorB = (valorB || '').toLowerCase();
                        }
                        // Tratar null/undefined
                        else if (valorA === null || valorA === undefined) {
                            valorA = '';
                            valorB = valorB || '';
                        }

                        if (valorA < valorB) return this.direcaoOrdenacao === 'asc' ? -1 : 1;
                        if (valorA > valorB) return this.direcaoOrdenacao === 'asc' ? 1 : -1;
                        return 0;
                    });
                },

                // Obter √≠cone de ordena√ß√£o
                getSortIcon(coluna) {
                    if (this.colunaOrdenacao !== coluna) return '‚áÖ';
                    return this.direcaoOrdenacao === 'asc' ? '‚Üë' : '‚Üì';
                },

                // Alternar status do usu√°rio
                toggleUserStatus(userId) {
                    if (!confirm('Deseja alterar o status deste usu√°rio?')) return;

                    fetch(`/admin/users/${userId}/toggle`, { method: 'PATCH' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                AlertManager.success('Status alterado com sucesso!');
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                AlertManager.error(data.message);
                            }
                        })
                        .catch(err => AlertManager.error('Erro ao alterar status'));
                },

                // Deletar usu√°rio
                deleteUser(userId) {
                    if (!confirm('Deseja realmente excluir este usu√°rio? Esta a√ß√£o n√£o pode ser desfeita!')) return;

                    fetch(`/admin/users/${userId}`, { method: 'DELETE' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                AlertManager.success('Usu√°rio exclu√≠do com sucesso!');
                                setTimeout(() => location.reload(), 1000);
                            } else {
                                AlertManager.error(data.message);
                            }
                        })
                        .catch(err => AlertManager.error('Erro ao excluir usu√°rio'));
                }
            }
        }
    </script>
</body>
</html>
