<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${tarefa != null ? 'Editar Tarefa' : 'Nova Tarefa'} + ' - Notisblokk'">Nova Tarefa - Notisblokk</title>

    <!-- Quill Editor CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <style>
        .editor-container {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
        }

        #editor {
            min-height: 400px;
            background-color: var(--color-surface);
            color: var(--color-text-primary);
        }

        .ql-toolbar {
            background-color: var(--color-background);
            border-top-left-radius: 0.375rem;
            border-top-right-radius: 0.375rem;
        }

        .ql-container {
            border-bottom-left-radius: 0.375rem;
            border-bottom-right-radius: 0.375rem;
        }

        /* Tema escuro para o Quill */
        [data-theme="dark"] .ql-toolbar button svg,
        [data-theme="dark"] .ql-toolbar .ql-stroke {
            stroke: var(--color-text-primary);
        }

        [data-theme="dark"] .ql-toolbar .ql-fill {
            fill: var(--color-text-primary);
        }

        [data-theme="dark"] .ql-toolbar .ql-picker-label {
            color: var(--color-text-primary);
        }

        /* Radio buttons para prazo r√°pido */
        .prazo-rapido-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .radio-prazo {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.5rem 0.875rem;
            background-color: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .radio-prazo:hover {
            background-color: var(--color-background);
            border-color: var(--color-primary);
        }

        .radio-prazo input[type="radio"] {
            cursor: pointer;
            accent-color: var(--color-primary);
        }

        .radio-prazo input[type="radio"]:checked + span {
            font-weight: 600;
            color: var(--color-primary);
        }

        .radio-prazo span {
            font-size: 0.9375rem;
            color: var(--color-text-primary);
        }

        .form-label-small {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-secondary);
            margin-bottom: 0.25rem;
            display: block;
        }

        .form-input-compact {
            width: 250px;
            padding: 0.5rem 0.75rem;
            font-size: 0.9375rem;
            line-height: 1.5;
            color: var(--color-text-primary);
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: 0.375rem;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-input-compact:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        @media (max-width: 768px) {
            .prazo-rapido-container {
                flex-direction: column;
            }

            .radio-prazo {
                width: 100%;
            }

            .form-input-compact {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <th:block th:replace="~{layout/base :: base(~{::main-content})}">
        <div th:fragment="main-content" x-data="notaFormApp()">
            <div class="mb-3" style="display: flex; gap: 0.75rem; align-items: center;">
                <a href="/tarefas" class="btn btn-secondary">‚Üê Voltar para Tarefas</a>
                <!-- Bot√£o de exportar PDF (s√≥ aparece ao editar tarefa existente) -->
                <button
                    type="button"
                    @click="exportarPDF()"
                    class="btn btn-success"
                    x-show="tarefaId"
                    title="Exportar esta tarefa em PDF">
                    üìÑ Exportar PDF
                </button>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title" th:text="${tarefa != null ? 'Editar Tarefa' : 'Nova Tarefa'}">Nova Tarefa</h2>
                </div>
                <div class="card-body">
                    <form id="notaForm">
                        <input type="hidden" id="tarefaId" th:value="${tarefa != null ? tarefa.id : ''}">

                        <div class="form-group">
                            <label class="form-label">T√≠tulo*</label>
                            <input type="text" id="titulo" class="form-input" th:value="${tarefa != null ? tarefa.titulo : ''}" required>
                        </div>

                        <div class="grid grid-cols-2 mb-3">
                            <div class="form-group">
                                <label class="form-label">Etiqueta*</label>
                                <select id="etiquetaId" class="form-select" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Status*</label>
                                <select id="statusId" class="form-select" required>
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Prazo Final*</label>

                            <!-- Radio buttons para per√≠odos padr√µes -->
                            <div class="prazo-rapido-container">
                                <label class="radio-prazo">
                                    <input type="radio" name="prazoRapido" value="1">
                                    <span>1 dia</span>
                                </label>
                                <label class="radio-prazo">
                                    <input type="radio" name="prazoRapido" value="3">
                                    <span>3 dias</span>
                                </label>
                                <label class="radio-prazo">
                                    <input type="radio" name="prazoRapido" value="5">
                                    <span>5 dias</span>
                                </label>
                                <label class="radio-prazo">
                                    <input type="radio" name="prazoRapido" value="7">
                                    <span>7 dias</span>
                                </label>
                                <label class="radio-prazo">
                                    <input type="radio" name="prazoRapido" value="15">
                                    <span>15 dias</span>
                                </label>
                                <label class="radio-prazo">
                                    <input type="radio" name="prazoRapido" value="30">
                                    <span>30 dias</span>
                                </label>
                            </div>

                            <!-- Datepicker compacto -->
                            <div style="margin-top: 0.75rem;">
                                <label class="form-label-small">Ou escolha a data manualmente:</label>
                                <input type="date" id="prazoFinal" class="form-input-compact" th:value="${tarefa != null ? tarefa.prazoFinal : ''}" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Conte√∫do</label>
                            <div class="editor-container">
                                <div id="editor"></div>
                            </div>
                            <input type="hidden" id="conteudo">
                        </div>

                        <div class="d-flex gap-2 mt-4">
                            <button type="submit" class="btn btn-primary">Salvar Tarefa</button>
                            <a href="/tarefas" class="btn btn-secondary">Cancelar</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </th:block>

    <!-- Quill Editor JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script th:inline="javascript">
        // Dados da tarefa(se estiver editando)
        const tarefaData = /*[[${tarefa}]]*/ null;

        /**
         * Fun√ß√£o Alpine.js para gerenciar o formul√°rio de tarefa
         * @returns {Object} Objeto com estado e m√©todos do formul√°rio
         */
        function notaFormApp() {
            return {
                tarefaId: tarefaData ? tarefaData.id : null,

                /**
                 * Inicializa o componente do formul√°rio
                 */
                init() {
                    this.setupKeyboardShortcuts();
                },

                /**
                 * Exporta a tarefa atual para PDF
                 * S√≥ funciona ao editar uma tarefa existente
                 */
                async exportarPDF() {
                    if (!this.tarefaId) {
                        alert('√â necess√°rio salvar a tarefa antes de exportar para PDF.');
                        return;
                    }

                    try {
                        console.log(`üìÑ Gerando PDF para tarefa ID: ${this.tarefaId}`);

                        // Fazer requisi√ß√£o para o endpoint de PDF
                        const response = await fetch(`/api/tarefas/${this.tarefaId}/pdf`);

                        if (!response.ok) {
                            throw new Error(`Erro ao gerar PDF: ${response.statusText}`);
                        }

                        // Converter resposta em blob
                        const blob = await response.blob();

                        // Obter t√≠tulo da tarefa para nome do arquivo
                        const tituloTarefa = document.getElementById('titulo').value || 'tarefa';

                        // Criar nome do arquivo limpo (sem caracteres especiais)
                        const nomeArquivo = tituloTarefa
                            .replace(/[^a-zA-Z0-9\s-]/g, '') // Remove caracteres especiais
                            .replace(/\s+/g, '_') // Substitui espa√ßos por underscore
                            .substring(0, 50); // Limita tamanho

                        // Gerar timestamp no formato brasileiro (DDMMYYYY)
                        const agora = new Date();
                        const dia = String(agora.getDate()).padStart(2, '0');
                        const mes = String(agora.getMonth() + 1).padStart(2, '0');
                        const ano = agora.getFullYear();
                        const timestamp = `${dia}${mes}${ano}`;

                        const nomeCompleto = `Tarefa_${nomeArquivo}_${timestamp}.pdf`;

                        // Criar link tempor√°rio para download
                        const url = window.URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = nomeCompleto;
                        document.body.appendChild(link);
                        link.click();

                        // Limpar
                        document.body.removeChild(link);
                        window.URL.revokeObjectURL(url);

                        console.log(`‚úì PDF gerado com sucesso: ${nomeCompleto}`);

                        // Feedback visual simples (ser√° substitu√≠do por toast na tarefa 2.1)
                        // Por enquanto, n√£o mostramos nada para n√£o poluir com alerts

                    } catch (error) {
                        console.error('‚ùå Erro ao gerar PDF:', error);
                        alert(`Erro ao exportar PDF: ${error.message}`);
                    }
                },

                /**
                 * Configura atalhos de teclado para o formul√°rio.
                 *
                 * Atalhos dispon√≠veis:
                 * - Ctrl+S: Salvar tarefa
                 * - Ctrl+P: Exportar PDF (apenas ao editar)
                 * - Esc: Cancelar e voltar
                 */
                setupKeyboardShortcuts() {
                    document.addEventListener('keydown', (e) => {
                        // Ctrl+S: Salvar tarefa
                        if (e.ctrlKey && e.key.toLowerCase() === 's') {
                            e.preventDefault();
                            console.log('‚å®Ô∏è Atalho: Ctrl+S - Salvando tarefa');
                            const form = document.getElementById('formNota');
                            if (form) {
                                form.dispatchEvent(new Event('submit', { cancelable: true, bubbles: true }));
                            }
                            return;
                        }

                        // Ctrl+P: Exportar PDF (apenas ao editar tarefa existente)
                        if (e.ctrlKey && e.key.toLowerCase() === 'p') {
                            e.preventDefault();
                            console.log('‚å®Ô∏è Atalho: Ctrl+P - Exportar PDF');
                            this.exportarPDF();
                            return;
                        }

                        // Esc: Cancelar e voltar
                        if (e.key === 'Escape') {
                            // Ignorar se estiver focado no editor Quill (para permitir Esc fechar dropdowns do editor)
                            if (e.target.closest('.ql-editor, .ql-toolbar')) {
                                return;
                            }
                            console.log('‚å®Ô∏è Atalho: ESC - Cancelar');
                            if (confirm('Deseja cancelar e voltar? Altera√ß√µes n√£o salvas ser√£o perdidas.')) {
                                window.location.href = '/tarefas';
                            }
                            return;
                        }
                    });

                    console.log('‚å®Ô∏è Atalhos de teclado configurados (Formul√°rio)');
                    console.log('üìã Atalhos dispon√≠veis:');
                    console.log('   ‚Ä¢ Ctrl+S: Salvar tarefa');
                    console.log('   ‚Ä¢ Ctrl+P: Exportar PDF');
                    console.log('   ‚Ä¢ Esc: Cancelar e voltar');
                }
            };
        }

        // Inicializar editor Quill
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    [{ 'font': [] }],
                    [{ 'size': ['small', false, 'large', 'huge'] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'align': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            },
            placeholder: 'Digite a descri√ß√£o da tarefa aqui...'
        });

        // Converte data brasileira (dd/MM/yyyy ou dd-MM-yyyy) para ISO (yyyy-MM-dd)
        function converterDataBrasileiraParaISO(dataBrasileira) {
            if (!dataBrasileira) return '';

            // Verifica se j√° est√° no formato ISO (yyyy-MM-dd)
            if (dataBrasileira.match(/^\d{4}-\d{2}-\d{2}$/)) {
                return dataBrasileira;
            }

            // Converte de dd/MM/yyyy para yyyy-MM-dd
            if (dataBrasileira.includes('/')) {
                const partes = dataBrasileira.split('/');
                if (partes.length === 3) {
                    return `${partes[2]}-${partes[1]}-${partes[0]}`;
                }
            }

            // Converte de dd-MM-yyyy para yyyy-MM-dd
            if (dataBrasileira.match(/^\d{2}-\d{2}-\d{4}$/)) {
                const partes = dataBrasileira.split('-');
                return `${partes[2]}-${partes[1]}-${partes[0]}`;
            }

            return dataBrasileira;
        }

        // Carregar etiquetas e status
        async function carregarDados() {
            try {
                // Carregar etiquetas
                const resEtiquetas = await fetch('/api/etiquetas');
                const dataEtiquetas = await resEtiquetas.json();
                console.log('Etiquetas carregadas:', dataEtiquetas);

                if (!dataEtiquetas.success) {
                    throw new Error(dataEtiquetas.message || 'Erro ao carregar etiquetas');
                }

                const etiquetas = dataEtiquetas.dados || [];

                const selectEtiqueta = document.getElementById('etiquetaId');
                etiquetas.forEach(etiqueta => {
                    const option = document.createElement('option');
                    option.value = etiqueta.id;
                    option.textContent = etiqueta.nome;
                    selectEtiqueta.appendChild(option);
                });

                // Carregar status
                const resStatus = await fetch('/api/status-tarefa');
                const dataStatus = await resStatus.json();
                console.log('Status carregados:', dataStatus);

                if (!dataStatus.success) {
                    throw new Error(dataStatus.message || 'Erro ao carregar status');
                }

                const statusList = dataStatus.dados || [];

                const selectStatus = document.getElementById('statusId');
                statusList.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.id;
                    option.textContent = status.nome;
                    selectStatus.appendChild(option);
                });

                // Se estiver editando, preencher dados
                if (tarefaData) {
                    console.log('üìù Dados da tarefarecebidos:', tarefaData);

                    document.getElementById('titulo').value = tarefaData.titulo || '';
                    document.getElementById('etiquetaId').value = tarefaData.etiqueta?.id || '';
                    document.getElementById('statusId').value = tarefaData.status?.id || '';

                    // Converter data brasileira para formato ISO (yyyy-MM-dd) para o input type="date"
                    console.log('üìÖ prazoFinal recebido:', tarefaData.prazoFinal);
                    console.log('üìÖ prazoFinalFormatado recebido:', tarefaData.prazoFinalFormatado);

                    // Tentar usar prazoFinal primeiro, depois prazoFinalFormatado como fallback
                    const dataParaConverter = tarefaData.prazoFinal || tarefaData.prazoFinalFormatado;
                    console.log('üìÖ Data para converter:', dataParaConverter);

                    const dataISO = converterDataBrasileiraParaISO(dataParaConverter);
                    console.log('üìÖ Data convertida para ISO:', dataISO);

                    document.getElementById('prazoFinal').value = dataISO;
                    console.log('üìÖ Campo prazoFinal preenchido com:', document.getElementById('prazoFinal').value);

                    // Carregar conte√∫do no editor
                    if (tarefaData.conteudo) {
                        quill.root.innerHTML = tarefaData.conteudo;
                    }
                }
            } catch (err) {
                console.error('Erro ao carregar dados:', err);
                alert('Erro ao carregar etiquetas e status');
            }
        }

        // Converte data ISO (yyyy-MM-dd) para brasileira (dd/MM/yyyy)
        function converterDataISOParaBrasileira(dataISO) {
            if (!dataISO) return '';

            // Verifica se j√° est√° no formato brasileiro (dd/MM/yyyy)
            if (dataISO.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dataISO;
            }

            // Converte de yyyy-MM-dd para dd/MM/yyyy
            const partes = dataISO.split('-');
            if (partes.length === 3) {
                return `${partes[2]}/${partes[1]}/${partes[0]}`;
            }

            return dataISO;
        }

        // Fun√ß√£o para calcular data futura
        function calcularDataFutura(dias) {
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + dias);
            const ano = hoje.getFullYear();
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const dia = String(hoje.getDate()).padStart(2, '0');
            return `${ano}-${mes}-${dia}`;
        }

        // Adicionar event listeners para os radio buttons de prazo r√°pido
        document.querySelectorAll('input[name="prazoRapido"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const dias = parseInt(e.target.value);
                const dataFutura = calcularDataFutura(dias);
                document.getElementById('prazoFinal').value = dataFutura;
                console.log(`üìÖ Prazo atualizado para +${dias} dia(s): ${dataFutura}`);
            });
        });

        // Desmarcar radio buttons quando o usu√°rio edita manualmente a data
        document.getElementById('prazoFinal').addEventListener('change', () => {
            document.querySelectorAll('input[name="prazoRapido"]').forEach(radio => {
                radio.checked = false;
            });
        });

        // Salvar tarefa
        document.getElementById('notaForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Pegar conte√∫do HTML do editor
            const conteudoHtml = quill.root.innerHTML;

            const tarefaId = document.getElementById('tarefaId').value;
            const titulo = document.getElementById('titulo').value;
            const etiquetaId = document.getElementById('etiquetaId').value;
            const statusId = document.getElementById('statusId').value;
            const prazoFinalISO = document.getElementById('prazoFinal').value;

            // Converter data de ISO para formato brasileiro antes de enviar
            const prazoFinal = converterDataISOParaBrasileira(prazoFinalISO);

            const dados = {
                titulo,
                etiquetaId: parseInt(etiquetaId),
                statusId: parseInt(statusId),
                prazoFinal,
                conteudo: conteudoHtml
            };

            try {
                const url = tarefaId ? `/api/tarefas/${tarefaId}` : '/api/tarefas';
                const method = tarefaId ? 'PUT' : 'POST';

                const res = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dados)
                });

                const data = await res.json();

                if (data.success) {
                    alert(data.message);
                    window.location.href = '/tarefas';
                } else {
                    alert('Erro: ' + data.message);
                }
            } catch (err) {
                console.error('Erro ao salvar tarefa:', err);
                alert('Erro ao salvar tarefa: ' + err.message);
            }
        });

        // Carregar dados ao iniciar
        carregarDados();
    </script>
</body>
</html>
